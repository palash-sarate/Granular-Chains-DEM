# Flexible granular chain simulation in LAMMPS

units       si
atom_style hybrid sphere molecular
boundary    f f f

special_bonds fene

# Read the atom and bond data from the data file.
read_data chain.data

# Ensure spherical properties are consistent (overrides data if needed)
# mm
set type 1 diameter 0.002
# kg/m3
set type 1 density 708.47
velocity all set 0.0 0.0 0.0

# Pin the first three beads in space (anchor group) and integrate only the rest
group anchors id 1 2 3
group mobile subtract all anchors

velocity anchors set 0.0 0.0 0.0
set group anchors omega 0.0 0.0 0.0

# Optional: create a unique output directory per run (portable on Windows PowerShell)
# shell powershell -NoProfile -Command "if (!(Test-Path 'post')) {New-Item -ItemType Directory -Path 'post' ^| Out-Null}; $counterPath = 'post/run_counter.txt'; if (!(Test-Path $counterPath)) {Set-Content -Path $counterPath -Value '0'}; $count = [int](Get-Content -Path $counterPath); $next = $count + 1; Set-Content -Path $counterPath -Value $next; $outdir = Join-Path 'post' ('run_{0:D4}' -f $next); New-Item -ItemType Directory -Path $outdir -Force ^| Out-Null; $forward = $outdir -replace '\\','/'; Set-Content -Path 'post/current_run.txt' -Value $forward; Set-Content -Path 'post/current_run.lmp' -Value ('variable outdir string ' + $forward);"
# include post/current_run.lmp

# Ensure a predictable output directory and set outdir
shell if not exist post_chain_flop mkdir post_chain_flop
shell if not exist post_chain_flop\current mkdir post_chain_flop\current
variable outdir string post_chain_flop/current

# Apply gravity perpendicular to the chain (chain aligned with +z, gravity along +x)
fix grav mobile gravity 9.81 vector 1 0 0
# fix 3 all wall/gran granular hertz/material 1e5 1e3 0.3 &
#     tangential mindlin NULL 1.0 0.5 zplane 0 NULL

fix floor all wall/gran granular hertz/material 2.0e11 0.3 5e-4 &
    tangential linear_history 300.0 1.0 0.1 &
    rolling sds 200.0 100.0 0.1 &
    twisting marshall &
    zplane NULL 0.013

fix ceil all wall/gran granular hertz/material 2.0e11 0.3 5e-4 &
    tangential linear_history 300.0 1.0 0.1 &
    rolling sds 200.0 100.0 0.1 &
    twisting marshall &
    zplane 0.08 NULL

comm_modify    vel yes

# define particle - particle interactions
pair_style      granular
pair_coeff  1 1 hertz/material 2.0e11 0.30 5.0e4 &
            tangential linear_history 8.0e10 5.0e3 0.40 &
            rolling sds 1.0e4 5.0e3 0.30 &
            twisting marshall

# Connect beads with a custom tabulated bond: no force between 2 mm and 3 mm,
# steep quadratic walls outside that window.
bond_style table spline 200
bond_coeff 1 bond_window.table WIN

# Define the angle style as Harmonic. This will act as our angular infinite well.
# The potential is given by E=K(θ−θ0)^2 where θ0 is the equilibrium angle.
# We will set θ0 to your desired limit of 38 degrees.
# angle_style table spline 2001      # use spline and match N_points in the file (2001 here)
# angle_coeff 1 bond_angle.table ANGLE_WELL

angle_style cosine
angle_coeff 1 0

# Use the standard NVE integrator for the mobile beads only.
fix integr mobile nve/sphere

# Set up neighbor list parameters (wider skin and higher per-atom quota prevent overflow)
neighbor 0.08 bin
neigh_modify delay 0 every 1 check yes one 10000

# Set a conservative timestep for the stiff bonded chain.
timestep 2.5e-7

# === 4. OUTPUTS & RUN ===
# Output thermodynamic data every 1000 timesteps.
thermo 1000
thermo_style custom step pe ke etotal press

# Output a dump file of the sphere coordinates for visualization (e.g., in ParaView)
dump 1 all custom 10000 ${outdir}/chain_*.dump id type x y z vx vy vz fx fy fz diameter
dump_modify 1 sort id

variable outdir delete
# unfix floor
# fix floor all wall/reflect zlo 0.005
# run 4800000
# unfix floor
# Run the simulation for 100000 timesteps = 1.0 s.
run 4800000
